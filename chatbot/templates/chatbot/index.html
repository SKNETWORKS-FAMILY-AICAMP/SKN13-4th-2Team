{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 75vh;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    .chat-log {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #f9f9f9;
    }
    .chat-message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .chat-message .message-bubble {
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
    }
    .chat-message.user .message-bubble {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
    }
    .chat-message.bot .message-bubble {
        background-color: #e9e9eb;
        color: #333;
        align-self: flex-start;
    }
    .chat-input-container {
        padding: 20px;
        border-top: 1px solid #ddd;
    }
    #recommendations-log .card {
        background-color: #fafafa;
    }
    .spotify-embed-container {
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .spotify-embed-container iframe {
        width: 100%;
        height: 80px; /* Compact player height */
        border: none;
    }

    /* New styles for recommendations */
    .recommendation-card {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .recommendation-card:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .recommendation-card .card-body {
        padding: 15px;
    }
    .album-art-container img {
        width: 60px; /* Slightly larger album art */
        height: 60px;
        border-radius: 8px; /* Slightly rounded corners for album art */
        object-fit: cover;
    }
    .track-title {
        font-size: 1rem; /* Adjust font size */
        font-weight: 600; /* Make title bolder */
        color: #333;
    }
    .track-artist {
        font-size: 0.85rem; /* Adjust font size */
        color: #666;
    }
    .track-actions .form-check-input {
        width: 1.2em; /* Larger checkbox */
        height: 1.2em;
        cursor: pointer;
    }
    .play-button {
        background-color: #1DB954; /* Spotify green */
        border-color: #1DB954;
        color: white;
        border-radius: 20px; /* Pill shape */
        padding: 5px 15px;
        font-size: 0.85rem;
        transition: background-color 0.2s ease;
    }
    .play-button:hover {
        background-color: #1ED760;
        border-color: #1ED760;
    }
</style>

<div class="row">
    <div class="col-md-7">
        <div class="chat-container">
            <div class="chat-log" id="chat-log">
                <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" class="form-control" id="chat-message-input" placeholder="{% trans "Type your message here..." %}">
                    <button class="btn btn-primary" id="chat-message-submit">{% trans "Send" %}</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">추천 음악</h5>
                
                <!-- Spotify Embed Player -->
                <div class="spotify-embed-container">
                    <iframe id="spotify-embed-player" src="" allow="encrypted-media"></iframe>
                </div>

                <div id="recommendations-log" style="max-height: 45vh; overflow-y: auto;"> <!-- Adjusted max-height -->
                    <p class="text-muted">추천 음악이 여기에 표시됩니다.</p>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-success" id="create-playlist-btn" style="display: none;">{% trans "Create Playlist with Selected" %}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const chatLog = document.querySelector('#chat-log');
    const chatMessageInput = document.querySelector('#chat-message-input');
    const chatMessageSubmit = document.querySelector('#chat-message-submit');
    const recommendationsLog = document.querySelector('#recommendations-log');
    const spotifyEmbedPlayer = document.getElementById('spotify-embed-player');

    // Function to record listening history
    function recordListeningHistory(spotifyId, title, artist, trackUrl) {
        fetch('{% url "mypage:record_listening_history" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'X-CSRFToken': getCookie('csrftoken') // Uncomment and implement getCookie if not using @csrf_exempt
            },
            body: JSON.stringify({
                spotify_id: spotifyId,
                title: title,
                artist: artist,
                track_url: trackUrl
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Listening history recorded successfully!');
            } else {
                console.error('Failed to record listening history:', data.message);
            }
        })
        .catch(error => {
            console.error('Error recording listening history:', error);
        });
    }

    // Function to play track in embed player
    function playTrackInEmbed(spotifyId, title, artist, trackUrl) {
        const embedUrl = `https://open.spotify.com/embed/track/${spotifyId}?utm_source=generator`;
        spotifyEmbedPlayer.src = embedUrl;
        recordListeningHistory(spotifyId, title, artist, trackUrl); // Record history when played in embed
    }

    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(
        protocol +
        window.location.host +
        '/ws/chat/'
    );

    chatSocket.onopen = function(e) {
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const sender = data.sender;
        const recommendations = data.recommendations || [];

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender);
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.classList.add('message-bubble');
        bubbleDiv.textContent = message;
        messageDiv.appendChild(bubbleDiv);
        
        chatLog.appendChild(messageDiv);

        if (sender === 'bot' && recommendations.length > 0) {
            recommendationsLog.innerHTML = ''; // Clear previous recommendations
            let recommendationsHtml = ''; // Use a temporary string to build HTML

            // Automatically play the first recommended track in the embed player
            if (recommendations.length > 0) {
                const firstTrack = recommendations[0];
                playTrackInEmbed(firstTrack.id, firstTrack.name, firstTrack.artist, firstTrack.url);
            }

            recommendations.forEach(track => {
                let albumImageHtml = '';
                if (track.album_image_url) {
                    albumImageHtml = `<div class="album-art-container me-3"><img src="${track.album_image_url}" alt="Album Art"></div>`;
                }
                recommendationsHtml += `
                    <div class="card mb-3 recommendation-card">
                        <div class="card-body d-flex align-items-center">
                            ${albumImageHtml}
                            <div class="flex-grow-1">
                                <h6 class="track-title mb-0">${track.name}</h6>
                                <p class="track-artist mb-0">${track.artist}</p>
                            </div>
                            <div class="track-actions d-flex align-items-center ms-3">
                                <input class="form-check-input track-checkbox me-2" type="checkbox" value="" id="track-${track.id}"
                                    data-track-id="${track.id}"
                                    data-track-name="${track.name}"
                                    data-track-artist="${track.artist}"
                                    data-track-url="${track.url}"
                                    data-album-image-url="${track.album_image_url || ''}">
                                <button class="btn btn-sm play-button" onclick="playTrackInEmbed('${track.id}', '${track.name}', '${track.artist}', '${track.url}');">{% trans "Play" %}</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            recommendationsLog.innerHTML = recommendationsHtml;
            // Show the create playlist button if there are recommendations
            if (recommendations.length > 0) {
                document.getElementById('create-playlist-btn').style.display = 'block';
            } else {
                document.getElementById('create-playlist-btn').style.display = 'none';
            }
        }
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    // ... (existing onclose, focus, onkeyup) ...

    const createPlaylistBtn = document.getElementById('create-playlist-btn');
    createPlaylistBtn.onclick = function() {
        const selectedTracks = [];
        document.querySelectorAll('.track-checkbox:checked').forEach(checkbox => {
            selectedTracks.push({
                id: checkbox.dataset.trackId,
                name: checkbox.dataset.trackName,
                artist: checkbox.dataset.trackArtist,
                url: checkbox.dataset.trackUrl,
                album_image_url: checkbox.dataset.albumImageUrl
            });
        });

        if (selectedTracks.length === 0) {
            alert('플레이리스트에 추가할 노래를 선택해주세요.');
            return;
        }

        // 사용자에게 플레이리스트 이름 입력받기
        const playlistName = prompt('새 플레이리스트의 이름을 입력해주세요:', '새 플레이리스트');
        if (playlistName === null || playlistName.trim() === '') {
            alert('플레이리스트 이름이 입력되지 않았습니다. 생성을 취소합니다.');
            return; // 사용자가 취소했거나 빈 이름을 입력한 경우
        }

        // 선택된 트랙과 플레이리스트 이름을 백엔드로 전송
        chatSocket.send(JSON.stringify({
            'type': 'create_playlist_request',
            'playlist_name': playlistName, // 플레이리스트 이름 추가
            'tracks': selectedTracks
        }));
        alert(`'${playlistName}' 플레이리스트 생성 요청을 보냈습니다.`);
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    chatMessageInput.focus();
    chatMessageInput.onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            chatMessageSubmit.click();
        }
    };

    chatMessageSubmit.onclick = function(e) {
        const message = chatMessageInput.value;
        if (message.trim() === '') return;

        chatSocket.send(JSON.stringify({
            'message': message
        }));
        
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', 'user');
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.classList.add('message-bubble');
        bubbleDiv.textContent = message;
        messageDiv.appendChild(bubbleDiv);
        
        chatLog.appendChild(messageDiv);
        
        chatMessageInput.value = '';
        chatLog.scrollTop = chatLog.scrollHeight;
    };
</script>
{% endblock %}