{% extends 'base.html' %}
{% load i18n %}

{% block content %}
    <h1 class="mb-4">{% trans "Music Chatbot" %}</h1>
    <div class="card mb-3">
        <div class="card-body">
            <div class="chat-window" id="chat-log" style="border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll; margin-bottom: 10px;">
                <!-- Chat messages will appear here -->
            </div>
            <div class="input-group">
                <input type="text" class="form-control" id="chat-message-input" placeholder="{% trans "Type your message here..." %}">
                <button class="btn btn-primary" id="chat-message-submit">{% trans "Send" %}</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2 class="card-title">{% trans "Recommended Music / Filters" %}</h2>
            <div id="recommendations-log">
                <p class="card-text">{% trans "Placeholder for recommended songs/playlists or filter options (e.g., Mood, Genre)." %}</p>
                <!-- Recommended items or filter UI will appear here -->
            </div>
        </div>
    </div>

    <script>
        const chatLog = document.querySelector('#chat-log');
        const chatMessageInput = document.querySelector('#chat-message-input');
        const chatMessageSubmit = document.querySelector('#chat-message-submit');
        const recommendationsLog = document.querySelector('#recommendations-log');

        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const chatSocket = new WebSocket(
            protocol +
            window.location.host +
            '/ws/chat/'
        );

        chatSocket.onopen = function(e) {
            // Send an initial message to get the bot's greeting
            chatSocket.send(JSON.stringify({
                'message': 'Hello' // Or any initial greeting
            }));
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const sender = data.sender;
            const recommendations = data.recommendations || [];

            if (sender === 'bot') {
                chatLog.innerHTML += '<p><strong>{% trans "Bot" %}:</strong> ' + message + '</p>';
                if (recommendations.length > 0) {
                    recommendationsLog.innerHTML = '<h5 class="mt-3">{% trans "Recommendations" %}:</h5>';
                    recommendations.forEach(track => {
                        recommendationsLog.innerHTML += `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6 class="card-title">${track.name}</h6>
                                    <p class="card-text">${track.artist}</p>
                                    <a href="${track.url}" target="_blank" class="btn btn-sm btn-success">{% trans "Listen on Spotify" %}</a>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    recommendationsLog.innerHTML = '<p class="card-text">{% trans "No recommendations found." %}</p>';
                }
            }
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        chatMessageInput.focus();
        chatMessageInput.onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                chatMessageSubmit.click();
            }
        };

        chatMessageSubmit.onclick = function(e) {
            const message = chatMessageInput.value;
            if (message.trim() === '') return; // Prevent sending empty messages

            chatSocket.send(JSON.stringify({
                'message': message
            }));
            chatLog.innerHTML += '<p><strong>{% trans "You" %}:</strong> ' + message + '</p>'; // Display user's message immediately
            chatMessageInput.value = '';
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to bottom
        };
    </script>
{% endblock %}